'use strict';

/******************************
 * SVG ICONS
 *****************************/

const lessIcon =
  '<svg width="100%" height="100%" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><rect id="less" x="0" y="0" width="48" height="48" style="fill:none;"/><path d="M11.254,15.828l3.731,0l-0,8.913c-0,0.495 0.235,0.656 0.42,0.656c0.08,0 0.155,0 0.31,-0.041l0.264,1.709c-0.285,0.105 -0.68,0.186 -1.18,0.186c-1.605,-0 -2.154,-1.05 -2.154,-2.655l-0,-7.541l-0.705,-0c-0.68,-0 -0.866,0.238 -0.866,1.103c0,0.865 0.08,1.632 0.08,2.577c0,1.21 -0.389,1.68 -1.179,1.865l-0,0.08c0.785,0.185 1.179,0.653 1.179,1.863c0,0.971 -0.08,1.712 -0.08,2.577c0,0.865 0.211,1.129 0.866,1.129l0.314,-0l0,1.211l-1.025,-0c-1.395,-0 -2.026,-0.55 -2.026,-2.26c0,-1.13 0.16,-1.71 0.16,-2.68c0,-0.55 -0.338,-1.131 -1.363,-1.156l-0,-1.366c1.025,-0.05 1.363,-0.629 1.363,-1.179c0,-0.97 -0.16,-1.601 -0.16,-2.731c0,-1.71 0.631,-2.26 2.051,-2.26Zm24.49,0.006l1.025,-0c1.395,-0 2.026,0.552 2.026,2.262c-0,1.1 -0.16,1.703 -0.16,2.729c-0,0.55 0.34,1.131 1.365,1.166l-0,1.365c-1.025,0.05 -1.365,0.63 -1.365,1.18c-0,1.02 0.16,1.6 0.16,2.73c-0,1.71 -0.636,2.26 -2.026,2.26l-1.025,0l-0,-1.26l0.316,0l0,-0.025c0.68,-0 0.866,-0.236 0.866,-1.131c-0,-0.865 -0.08,-1.629 -0.08,-2.574c-0,-1.21 0.389,-1.681 1.179,-1.866l0,-0.08c-0.785,-0.185 -1.179,-0.655 -1.179,-1.865c-0,-0.945 0.08,-1.759 0.08,-2.574c-0,-0.871 -0.156,-1.106 -0.866,-1.106l-0.316,-0l-0,-1.211Zm-16.503,3.151c2.205,-0 3.365,1.655 3.336,3.787c0,0.42 -0.055,0.786 -0.08,0.971l-4.762,-0c0.21,1.21 1.026,1.709 2.076,1.709c0.58,-0 1.129,-0.16 1.709,-0.5l0.791,1.39c-0.815,0.555 -1.865,0.895 -2.81,0.895c-2.256,0 -3.967,-1.525 -3.967,-4.125c-0.05,-2.521 1.787,-4.127 3.707,-4.127Zm0.025,1.759c-0.735,0 -1.365,0.501 -1.525,1.551l2.84,0c-0,-0.895 -0.37,-1.551 -1.315,-1.551Zm7.042,-1.734c1.21,-0 2.105,0.525 2.76,1.025l-1.051,1.389c-0.575,-0.42 -1.1,-0.654 -1.68,-0.654c-0.58,-0 -0.895,0.236 -0.895,0.631c0,0.525 0.734,0.708 1.549,1.023c1.025,0.341 2.157,0.947 2.153,2.391c-0,1.445 -1.133,2.551 -3.233,2.551c-1,-0 -2.204,-0.451 -2.994,-1.106l1.025,-1.525c0.71,0.55 1.371,0.814 2.026,0.814c0.71,0 1.023,-0.259 1.023,-0.654c0,-0.525 -0.788,-0.79 -1.603,-1.105c-0.945,-0.365 -2.077,-1.024 -2.077,-2.309c0,-1.445 1.212,-2.471 2.997,-2.471Zm6.385,-0c1.21,-0 2.105,0.525 2.76,1.025l-1.049,1.389c-0.575,-0.42 -1.1,-0.654 -1.68,-0.654c-0.58,-0 -0.896,0.236 -0.896,0.631c-0,0.525 0.735,0.708 1.525,1.023c1.025,0.341 2.153,0.946 2.153,2.391c-0,1.445 -1.133,2.551 -3.233,2.551c-1,-0 -2.204,-0.451 -2.994,-1.106l1.049,-1.525c0.71,0.55 1.37,0.814 2.025,0.814c0.71,0 1.026,-0.259 1.026,-0.654c-0,-0.525 -0.791,-0.79 -1.606,-1.105c-0.945,-0.365 -2.074,-1.024 -2.074,-2.309c-0,-1.445 1.209,-2.471 2.994,-2.471Zm-5.693,19.384l2.657,0l-5.657,5.657l-5.657,-5.657l2.657,0l0,-7l6,0l0,7Z"/></svg>';

const cssIcon =
  '<svg width="100%" height="100%" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><rect id="css" x="0" y="0" width="48" height="48" style="fill:none;"/><path d="M34.244,15.835l1.025,0c1.395,0 2.026,0.552 2.026,2.262c-0,1.1 -0.16,1.704 -0.16,2.729c-0,0.55 0.34,1.131 1.365,1.166l-0,1.365c-1.025,0.05 -1.365,0.63 -1.365,1.18c-0,1.02 0.16,1.601 0.16,2.731c-0,1.71 -0.636,2.26 -2.026,2.26l-1.025,-0l-0,-1.26l0.316,-0l0,-0.026c0.68,0 0.866,-0.235 0.866,-1.13c-0,-0.866 -0.08,-1.63 -0.08,-2.575c-0,-1.21 0.389,-1.68 1.179,-1.865l0,-0.08c-0.785,-0.185 -1.179,-0.656 -1.179,-1.866c-0,-0.945 0.08,-1.759 0.08,-2.574c-0,-0.87 -0.156,-1.106 -0.866,-1.106l-0.316,0l-0,-1.211Zm-20.488,0l0,1.211l-0.316,0c-0.71,0 -0.866,0.236 -0.866,1.106c0,0.815 0.08,1.629 0.08,2.574c0,1.21 -0.394,1.681 -1.179,1.866l-0,0.08c0.79,0.185 1.179,0.655 1.179,1.865c0,0.945 -0.08,1.709 -0.08,2.575c0,0.895 0.186,1.13 0.866,1.13l-0,0.026l0.316,-0l0,1.26l-1.025,-0c-1.39,-0 -2.026,-0.55 -2.026,-2.26c0,-1.13 0.16,-1.711 0.16,-2.731c0,-0.55 -0.34,-1.13 -1.365,-1.18l0,-1.365c1.025,-0.035 1.365,-0.616 1.365,-1.166c0,-1.025 -0.16,-1.629 -0.16,-2.729c0,-1.71 0.631,-2.262 2.026,-2.262l1.025,0Zm4.076,11.532c-2.296,0 -4.144,-1.756 -4.144,-4.155l0,-0.023c0,-2.341 1.802,-4.178 4.236,-4.178c1.641,0 2.697,0.689 3.408,1.676l-1.675,1.297c-0.459,-0.574 -0.987,-0.941 -1.756,-0.941c-1.125,0 -1.917,0.953 -1.917,2.123l-0,0.023c-0,1.206 0.792,2.147 1.917,2.147c0.837,-0 1.331,-0.39 1.813,-0.976l1.676,1.194c-0.758,1.044 -1.779,1.813 -3.558,1.813Zm6.949,-8.356c1.21,0 2.105,0.526 2.76,1.026l-1.051,1.389c-0.575,-0.42 -1.1,-0.655 -1.68,-0.655c-0.58,0 -0.895,0.236 -0.895,0.631c0,0.525 0.734,0.709 1.549,1.024c1.025,0.341 2.157,0.946 2.153,2.39c-0,1.446 -1.133,2.551 -3.233,2.551c-1,0 -2.204,-0.45 -2.994,-1.105l1.025,-1.526c0.71,0.55 1.371,0.815 2.026,0.815c0.71,-0 1.023,-0.259 1.023,-0.654c0,-0.525 -0.788,-0.791 -1.603,-1.106c-0.945,-0.365 -2.077,-1.024 -2.077,-2.309c0,-1.445 1.212,-2.471 2.997,-2.471Zm6.385,0c1.21,0 2.105,0.526 2.76,1.026l-1.049,1.389c-0.575,-0.42 -1.1,-0.655 -1.68,-0.655c-0.58,0 -0.896,0.236 -0.896,0.631c-0,0.525 0.735,0.709 1.525,1.024c1.025,0.341 2.153,0.945 2.153,2.39c-0,1.446 -1.133,2.551 -3.233,2.551c-1,0 -2.204,-0.45 -2.994,-1.105l1.048,-1.526c0.711,0.55 1.371,0.815 2.026,0.815c0.71,-0 1.025,-0.259 1.025,-0.654c0,-0.525 -0.79,-0.791 -1.605,-1.106c-0.945,-0.365 -2.074,-1.024 -2.074,-2.309c-0,-1.445 1.209,-2.471 2.994,-2.471Zm-4.166,19.383l2.657,0l-5.657,5.657l-5.657,-5.657l2.657,0l0,-7l6,0l0,7Z"/></svg>';

const themeIcon =
  '<svg width="100%" height="100%" viewBox="0 0 48 48" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><rect id="css" x="0" y="0" width="48" height="48" style="fill:none;"/><path d="M15.34,19c2.759,-4.78 8.88,-6.42 13.66,-3.66c4.78,2.759 6.42,8.88 3.66,13.66c-2.759,4.78 -8.88,6.42 -13.66,3.66c-4.78,-2.759 -6.42,-8.88 -3.66,-13.66Zm12.879,-2.307l-8.438,14.614c4.033,2.328 9.198,0.945 11.526,-3.088c2.328,-4.033 0.945,-9.198 -3.088,-11.526Z"/></svg>';

/******************************
 * LCSSP Constans
 *****************************/

const playground = document.querySelector('.playground-wrapper');
const editorParent = document.querySelector('.playground-wrapper > .editor');
const lessContainer = document.getElementById('containerLess');
const cssContainer = document.getElementById('containerCss');

/******************************
 * CREATE EDITORS
 *****************************/

lessContainer.setAttribute(
  'width',
  editorParent.getBoundingClientRect().width + 'px'
);
lessContainer.setAttribute(
  'height',
  editorParent.getBoundingClientRect().height + 'px'
);

cssContainer.setAttribute(
  'width',
  editorParent.getBoundingClientRect().width + 'px'
);
cssContainer.setAttribute(
  'height',
  editorParent.getBoundingClientRect().height + 'px'
);

window.addEventListener(
  'resize',
  function (event) {
    lessContainer.setAttribute(
      'width',
      editorParent.getBoundingClientRect().width + 'px'
    );
    lessContainer.setAttribute(
      'height',
      editorParent.getBoundingClientRect().height + 'px'
    );

    cssContainer.setAttribute(
      'width',
      editorParent.getBoundingClientRect().width + 'px'
    );
    cssContainer.setAttribute(
      'height',
      editorParent.getBoundingClientRect().height + 'px'
    );
    editorLess.layout();
    editorCss.layout();
  },
  true
);

let editorLess = monaco.editor.create(lessContainer, {
  value: [''].join('\n'),
  theme: 'vs-dark',
  language: 'less',
});

let editorCss = monaco.editor.create(cssContainer, {
  readOnly: true,
  value: [''].join('\n'),
  language: 'css',
});

// SET DEFAULT VALUE
let valueTest = `/***************************************************
  Wellcome to Less CSS Playground!

  You can write any "less css" syntax here and see the
  compiled css in the second window.
  
  More info: https://lesscss.org/

  This editor is a Monaco Editor, more info here:
  https://microsoft.github.io/monaco-editor/

 ***************************************************/
`;
editorLess.onDidCompositionEnd(editorLess.setValue(valueTest));
//editorCss.onDidCompositionEnd(editorCss.setValue(valueTest));

window.LessEditorError = null;
window.LessEditorData = null;

editorLess.onDidChangeModelDecorations(function () {
  LessEditorError = monaco.editor.getModelMarkers(editorLess.getModel()).length;
});

editorLess.onDidChangeModelContent(function () {
  let data = editorLess.getValue();
  setTimeout(function () {
    if (LessEditorError == 0 && LessEditorData != data) {
      //console.log(data);
      less.render(data).then(function (output) {
        // output.css = string of css
        console.log(output.css);
        editorCss.setValue(output.css);
      });
    }
  }, 1000);
});

/******************************
 * GET TOOLBAR TEMPLATE
 *****************************/
let toolbarTemplate = document.getElementById('toolbar');
let LessToolbarTemplateClone = toolbarTemplate.content.cloneNode(true);
let CssToolbarTemplateClone = toolbarTemplate.content.cloneNode(true);

toolbarTemplate.remove();
toolbarTemplate = null;

/******************************
 * REFORMAT TEMPLATE
 *****************************/
LessToolbarTemplateClone.querySelector('.toolbar').setAttribute(
  'data-id',
  '#containerLess'
);
LessToolbarTemplateClone.querySelector('h1.title').innerHTML =
  '{less}' + '<small> Playground</small>';

LessToolbarTemplateClone.querySelector('.button.theme .icon').innerHTML =
  themeIcon;

LessToolbarTemplateClone.querySelector('.button.raw .icon').innerHTML =
  lessIcon;

LessToolbarTemplateClone.querySelector('.button.theme').addEventListener(
  'click',
  function (e) {
    switchTheme();
  }
);

CssToolbarTemplateClone.querySelector('.toolbar').setAttribute(
  'data-id',
  '#containerCss'
);
CssToolbarTemplateClone.querySelector('h1.title').innerHTML =
  '{css}' + '<small> Compiled</small>';

CssToolbarTemplateClone.querySelector('.button.theme').remove();
CssToolbarTemplateClone.querySelector('.button.raw .icon').innerHTML = cssIcon;

/******************************
 * PLACE TOOLBARS
 *****************************/

const placeToolbar = function (el) {
  let cnt = el.querySelector('.toolbar').getAttribute('data-id');
  cnt = document.querySelector(cnt);
  cnt.prepend(el);
};

editorLess.onDidCompositionEnd(placeToolbar(LessToolbarTemplateClone));
editorCss.onDidCompositionEnd(placeToolbar(CssToolbarTemplateClone));

/******************************
 * FUNCTIONS
 *****************************/

const downloadFile = function (data, element = null) {};

const switchTheme = function (data) {
  if (editorLess._themeService.getColorTheme().id == 'vs-dark') {
    monaco.editor.setTheme('vs-light');
    document.querySelector('.playground-wrapper').classList.add('light');
  } else {
    monaco.editor.setTheme('vs-dark');
    document.querySelector('.playground-wrapper').classList.remove('light');
  }
  console.log();
};

const monacoResizer = function (controlElement, editorsContainersArray) {
  // Set dimension
  let dimensions = controlElement.getBoundingClientRect();
  editorsContainersArray.forEach((el) => {
    el.setAttribute(
      'style',
      'width: ' + dimensions.width + 'px; height:' + dimensions.height + 'px;'
    );
  });
  // Repaint editors
  monaco.editor.getModels().forEach((editor) => {
    editor.layout();
  });
};
